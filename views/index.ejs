<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .chat-panel { background: #f8f9fa; }
    .chat-messages { border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; }
    .theme-display { }
    .component-card, .layout-card { border: 2px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 5px; cursor: pointer; transition: all 0.3s; }
    .component-card:hover, .layout-card:hover { border-color: #0d6efd; transform: translateY(-5px); box-shadow: 0 4px 12px rgba(13,110,253,0.2); }
    .badge-free { background: #198754; }
    .badge-paid { background: #ffc107; color: black; }
    .badge-pro { background: #0d6efd; }
    .json-display { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-top: 20px; max-height: 600px; overflow-y: auto; }
    .json-display pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row h-100">
      <div class="col-lg-3 chat-panel p-4 border-end" style="max-height: 100vh; overflow-y: auto;">
        <h3 class="mb-4"><strong>Theme Generator</strong></h3>
        <div id="chatContainer" class="chat-messages mb-3" style="height: 400px; overflow-y: auto;"></div>
        <div class="input-group mb-3">
          <input type="text" id="userMessage" class="form-control" placeholder="Describe your theme...">
          <button class="btn btn-primary" onclick="sendMessage()">Send</button>
        </div>
        <div class="mb-3">
          <label><strong>Plan:</strong></label>
          <select id="planSelect" class="form-select">
            <option value="free">Free</option>
            <option value="paid">Paid</option>
          </select>
        </div>
      </div>
      <div class="col-lg-9 theme-display p-4" style="max-height: 100vh; overflow-y: auto;">
        <h2 class="mb-4">Generated Theme</h2>
        <div id="summaryContainer" class="alert alert-info" style="display:none;"></div>
        <div id="componentsContainer" class="mb-4">
          <h4>Components (7 Pages)</h4>
          <div id="componentsList" class="row"></div>
        </div>
        <div id="layoutsContainer" class="mb-4">
          <h4>Layouts (5 Pages)</h4>
          <div id="layoutsList" class="row"></div>
        </div>
        <div id="jsonContainer" class="json-display" style="display:none;">
          <h5>Generated JSON</h5>
          <pre id="jsonContent"></pre>
          <button class="btn btn-sm btn-info mt-2" onclick="copyJSON()">Copy JSON</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let lastThemeData = null;

    async function sendMessage() {
      const msg = document.getElementById('userMessage').value.trim();
      const plan = document.getElementById('planSelect').value;
      if (!msg) return;
      document.getElementById('userMessage').value = '';
      
      const chatDiv = document.getElementById('chatContainer');
      chatDiv.innerHTML += `<div class="mb-2"><strong>You:</strong> ${msg}</div>`;
      chatDiv.scrollTop = chatDiv.scrollHeight;

      try {
        const res = await fetch('/api/theme/generate', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({message: msg, plan})
        });

        const data = await res.json();
        if (data.success) {
          lastThemeData = data.theme;
          displayTheme(data.theme);
          chatDiv.innerHTML += `<div class="mb-2 text-success"><strong>AI:</strong> ‚úì Theme generated successfully<br/>üìä Components: ${data.theme.summary.total_components}<br/>üìê Layouts: ${data.theme.summary.total_layouts}</div>`;
        } else {
          chatDiv.innerHTML += `<div class="mb-2 text-danger"><strong>Error:</strong> ${data.error}</div>`;
        }
      } catch(e) {
        chatDiv.innerHTML += `<div class="mb-2 text-danger"><strong>Error:</strong> ${e.message}</div>`;
      }
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function displayTheme(theme) {
      // Display summary
      const summaryDiv = document.getElementById('summaryContainer');
      summaryDiv.innerHTML = `
        <strong>Theme Generated Successfully!</strong><br/>
        Plan: <span class="badge ${theme.plan === 'free' ? 'badge-free' : 'badge-paid'}">${theme.plan.toUpperCase()}</span><br/>
        Total Components: ${theme.summary.total_components} | Total Layouts: ${theme.summary.total_layouts}
      `;
      summaryDiv.style.display = 'block';

      // Display components
      const componentsList = document.getElementById('componentsList');
      componentsList.innerHTML = '';
      (theme.components || []).forEach((comp, idx) => {
        const isFree = comp.plans === '1';
        const card = `
          <div class="col-md-6 col-lg-4">
            <div class="component-card">
              <h6>${comp.title}</h6>
              <small><strong>Type:</strong> ${comp.type}</small><br/>
              <small><strong>Files:</strong> ${comp.ejs_file} / ${comp.css_file} / ${comp.js_file}</small><br/>
              <div class="mt-2">
                <span class="badge ${isFree ? 'badge-free' : 'badge-paid'}">${isFree ? 'FREE' : 'PRO'}</span>
              </div>
            </div>
          </div>
        `;
        componentsList.innerHTML += card;
      });

      // Display layouts
      const layoutsList = document.getElementById('layoutsList');
      layoutsList.innerHTML = '';
      (theme.layouts || []).forEach((layout, idx) => {
        const isFree = layout.plans === '1';
        const card = `
          <div class="col-md-6 col-lg-4">
            <div class="layout-card">
              <h6>${layout.title}</h6>
              <small><strong>Type:</strong> ${layout.type}</small><br/>
              <small><strong>EJS:</strong> ${layout.ejs_file}</small><br/>
              <div class="mt-2">
                <span class="badge ${isFree ? 'badge-free' : 'badge-paid'}">${isFree ? 'FREE' : 'PRO'}</span>
              </div>
            </div>
          </div>
        `;
        layoutsList.innerHTML += card;
      });

      // Display JSON
      const jsonDiv = document.getElementById('jsonContainer');
      const jsonContent = document.getElementById('jsonContent');
      jsonContent.textContent = JSON.stringify(theme, null, 2);
      jsonDiv.style.display = 'block';
    }

    function copyJSON() {
      const jsonContent = document.getElementById('jsonContent').textContent;
      navigator.clipboard.writeText(jsonContent).then(() => {
        alert('JSON copied to clipboard!');
      }).catch(err => {
        alert('Failed to copy JSON: ' + err);
      });
    }
  </script>
</body>
</html>
