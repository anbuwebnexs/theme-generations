<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .chat-panel { background: #f8f9fa; }
    .chat-messages { border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; }
    .theme-display { }
    .layout-card { border: 2px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 5px; cursor: pointer; transition: all 0.3s; }
    .layout-card:hover { border-color: #0d6efd; transform: translateY(-5px); box-shadow: 0 4px 12px rgba(13,110,253,0.2); }
    .badge-free { background: #198754; } .badge-paid { background: #ffc107; color: black; }
    .badge-default { background: #0d6efd; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row h-100">
      <div class="col-lg-3 chat-panel p-4 border-end" style="max-height: 100vh; overflow-y: auto;">
        <h3 class="mb-4"><strong>Theme Generator</strong></h3>
        <div id="chatContainer" class="chat-messages mb-3" style="height: 400px; overflow-y: auto;"></div>
        <div class="input-group mb-3">
          <input type="text" id="userMessage" class="form-control" placeholder="Describe your theme...">
          <button class="btn btn-primary" onclick="sendMessage()">Send</button>
        </div>
        <div class="mb-3">
          <label><strong>Plan:</strong></label>
          <select id="planSelect" class="form-select">
            <option value="free">Free</option>
            <option value="paid">Paid</option>
          </select>
        </div>
      </div>
      <div class="col-lg-9 theme-display p-4" style="max-height: 100vh; overflow-y: auto;">
        <h2 class="mb-4">Generated Theme Layouts</h2>
        <div id="layoutsContainer" class="row"></div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function sendMessage() {
      const msg = document.getElementById('userMessage').value.trim();
      const plan = document.getElementById('planSelect').value;
      if (!msg) return;
      document.getElementById('userMessage').value = '';
      const chatDiv = document.getElementById('chatContainer');
      chatDiv.innerHTML += `<div class="mb-2"><strong>You:</strong> ${msg}</div>`;
      chatDiv.scrollTop = chatDiv.scrollHeight;
      try {
        const res = await fetch('/api/theme/generate', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({message: msg, plan})}); 
        const data = await res.json();
        if (data.success) {
          displayTheme(data.theme);
          chatDiv.innerHTML += `<div class="mb-2 text-success"><strong>AI:</strong> Theme generated successfully!</div>`;
        } else {
          chatDiv.innerHTML += `<div class="mb-2 text-danger"><strong>Error:</strong> ${data.error}</div>`;
        }
      } catch(e) {
        chatDiv.innerHTML += `<div class="mb-2 text-danger"><strong>Error:</strong> ${e.message}</div>`;
      }
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }
    function displayTheme(theme) {
      const container = document.getElementById('layoutsContainer');
      container.innerHTML = '';
      const pages = theme.pages || {};
      Object.keys(pages).forEach(pageName => {
        const page = pages[pageName];
        const layouts = page.layouts || [];
        layouts.forEach((layout, idx) => {
          const isFree = layout.plan === 'free';
          const isDefault = layout.id === page.defaultLayoutId;
          const card = `<div class="col-md-6 col-lg-4">
            <div class="layout-card">
              <h5>${layout.name}</h5>
              <div>
                <span class="badge ${isFree ? 'badge-free' : 'badge-paid'}">${isFree ? 'Free' : 'Paid'}</span>
                ${isDefault ? '<span class="badge badge-default">Default</span>' : ''}
              </div>
              <p class="text-muted mt-2"><strong>Page:</strong> ${pageName}</p>
            </div>
          </div>`;
          container.innerHTML += card;
        });
      });
    }
  </script>
</body>
</html>
